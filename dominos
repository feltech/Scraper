# Go into this script's folder.
cd "$(dirname `realpath $0`)"
# In case things are stored in local, and we're running in cron.
export PATH="$PATH:/usr/local/bin"
# Store email address given in options (blank means just stdout).
EMAIL=""
# Store postcode (required).
POSTCODE=""

# Parse the command line options.

PARSED=`getopt --options m:,p: --longoptions mail:,postcode: --name "$0" -- "$@"`
if [[ $? -ne 0 ]]; then
  exit 2
fi
# -- use eval with "$PARSED" to properly handle the quoting
eval set -- "$PARSED"

while true; do
  case "$1" in
    -m|--mail)
      EMAIL="$2"
      shift 2
    ;;
    -p|--postcode)
      POSTCODE="$2"
      shift 2
    ;;
    --)
      shift
      break
    ;;
    *)
      echo "Programming error"
      exit 3
    ;;  
  esac
done

# -- handle non-option arguments
if [[ $# -ne 0 ]]; then
  echo "$0: unknown additional parameter '$1'"
  exit 4
fi

# The magic script.
CMD="casperjs --ignore-ssl-errors=true --ssl-protocol=any dominos.js $POSTCODE"

# Execute the command, emailing output if address given.
if [ "$EMAIL" != "" ]; then
  output=$($CMD);

  case $? in
    100) subject="No Vouchers Found" ;;
    0) subject="Vouchers Found!" ;;
    *) subject="Script Error" ;;
  esac

  echo "$output" | mail -s "Dominos Vouchers - $subject" $EMAIL;

else
  $CMD
fi
